<%- include('../partials/header') %>
<%- include('../partials/navbar') %>

<div class="container">
  <h1>üìÖ L·∫≠p L·ªãch Chi·∫øu Phim</h1>

  <% if (message) { %>
    <div class="alert alert-<%= message.type %>">
      <strong><%= message.type === 'success' ? '‚úì' : '‚ö†Ô∏è' %></strong>
      <%= message.text %>
    </div>
  <% } %>

  <!-- Redesigned form with better layout and improved styling -->
  <div class="form-box">
    <h2>üìù Th√™m Su·∫•t Chi·∫øu M·ªõi</h2>
    <form method="POST" action="/management/schedule/add">
      <div class="form-row">
        <div class="form-group">
          <label for="theaterId">Ch·ªçn r·∫°p</label>
          <select id="theaterId" name="theaterId" required onchange="updateRoomOptions()">
            <option value="">-- Ch·ªçn r·∫°p --</option>
            <% theaters.forEach(theater => { %>
              <option value="<%= theater.id %>"><%= theater.name %></option>
            <% }) %>
          </select>
        </div>

        <div class="form-group">
          <label for="movieId">Ch·ªçn phim</label>
          <select id="movieId" name="movieId" required>
            <option value="">-- Ch·ªçn phim --</option>
            <% movies.forEach(movie => { %>
              <option value="<%= movie.id %>"><%= movie.title %></option>
            <% }) %>
          </select>
        </div>

        <div class="form-group">
          <label for="roomId">Ch·ªçn ph√≤ng</label>
          <select id="roomId" name="roomId" required>
            <option value="">-- Ch·ªçn ph√≤ng --</option>
            <% rooms.forEach(room => { %>
              <option value="<%= room.id %>" data-theater="<%= room.theaterId %>"><%= room.name %> (<%= room.type %>, <%= room.seats %> gh·∫ø)</option>
            <% }) %>
          </select>
        </div>

        <div class="form-group">
          <label for="shiftId">Ch·ªçn ca</label>
          <select id="shiftId" name="shiftId" required>
            <option value="">-- Ch·ªçn ca --</option>
            <% shifts.forEach(shift => { %>
              <option value="<%= shift.id %>"><%= shift.name %> (<%= shift.time %>)</option>
            <% }) %>
          </select>
        </div>

        <div class="form-group">
          <label for="date">Ch·ªçn ng√†y</label>
          <input type="date" id="date" name="date" required>
        </div>

        <!-- Enhanced pricing section with icons -->
        <div class="form-group">
          <label for="standardPrice">Gi√° v√© th∆∞·ªùng</label>
          <input type="number" id="standardPrice" name="standardPrice" required min="0" step="1000" placeholder="50000">
        </div>

        <div class="form-group">
          <label for="vipPrice">Gi√° v√© VIP</label>
          <input type="number" id="vipPrice" name="vipPrice" required min="0" step="1000" placeholder="80000">
        </div>

        <div class="form-group">
          <button type="submit" class="btn btn-primary btn-block">+ Th√™m su·∫•t chi·∫øu</button>
        </div>
      </div>
    </form>
  </div>

  <!-- Improved results box with ticket status -->
  <div class="results-box">
    <h2>üìä L·ªãch Chi·∫øu Hi·ªán T·∫°i</h2>
    <% if (showtimes.length > 0) { %>
    <div style="overflow-x: auto;">
      <table class="table">
        <thead>
          <tr>
            <th>Phim</th>
            <th>R·∫°p</th>
            <th>Ph√≤ng</th>
            <th>Ca chi·∫øu</th>
            <th>Ng√†y</th>
            <th>Gi√° th∆∞·ªùng</th>
            <th>Gi√° VIP</th>
            <th>T√¨nh tr·∫°ng v√©</th>
            <th>Thao t√°c</th>
          </tr>
        </thead>
        <tbody>
          <% showtimes.forEach(st => { 
            const availableSeats = st.totalSeats - st.soldTickets;
            const percentSold = st.totalSeats > 0 ? (st.soldTickets / st.totalSeats * 100).toFixed(0) : 0;
            let statusClass = 'available';
            let statusText = 'C√≤n ch·ªó';
            
            if (st.isSoldOut) {
              statusClass = 'soldout';
              statusText = 'H·∫øt v√©';
            } else if (percentSold >= 70) {
              statusClass = 'filling';
              statusText = 'S·∫Øp h·∫øt';
            }
          %>
          <tr>
            <td><strong><%= st.movieTitle %></strong></td>
            <td><%= st.theaterName %></td>
            <td><%= st.roomName %></td>
            <td><%= st.shiftName %> (<%= st.shiftTime %>)</td>
            <td><%= st.date %></td>
            <td><span style="color: #34c759; font-weight: 600;"><%= st.standardPrice.toLocaleString('vi-VN') %> ƒë</span></td>
            <td><span style="color: #ffc107; font-weight: 600;"><%= st.vipPrice.toLocaleString('vi-VN') %> ƒë</span></td>
            <td>
              <div style="display: flex; flex-direction: column; gap: 4px; align-items: center;">
                <span class="seat-availability <%= statusClass %>">
                  <%= statusText %>
                </span>
                <small style="color: #666; font-size: 12px;">
                  <%= st.soldTickets %>/<%= st.totalSeats %> v√©
                </small>
              </div>
            </td>
            <td>
              <form method="POST" action="/management/schedule/delete/<%= st.id %>" style="display: inline;">
                <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a su·∫•t chi·∫øu n√†y?')">
                  üóëÔ∏è X√≥a
                </button>
              </form>
            </td>
          </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <% } else { %>
      <p class="no-data">Ch∆∞a c√≥ su·∫•t chi·∫øu n√†o ƒë∆∞·ª£c l·∫≠p.</p>
    <% } %>
  </div>
</div>

<script>
  const theaterRoomsData = <%- JSON.stringify(rooms) %>;

  function updateRoomOptions() {
    const theaterId = document.getElementById('theaterId').value;
    const roomSelect = document.getElementById('roomId');
    
    roomSelect.innerHTML = '<option value="">-- Ch·ªçn ph√≤ng --</option>';
    
    if (theaterId) {
      theaterRoomsData
        .filter(r => r.theaterId === parseInt(theaterId))
        .forEach(room => {
          const option = document.createElement('option');
          option.value = room.id;
          option.textContent = `${room.name} (${room.type}, ${room.seats} gh·∫ø)`;
          roomSelect.appendChild(option);
        });
    }
  }
</script>

<%- include('../partials/footer') %>